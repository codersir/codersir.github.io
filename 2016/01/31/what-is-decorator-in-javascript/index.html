<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>JavaScript 中的装饰器是什么？ | Coder Sir</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="装饰器是 ES7（也就是ES2016）的提案，虽然听着感觉好像还有点遥远，毕竟 ES6 还没有走多久呢，但实际上，2016年已经到来，也就是说，ES7 的提案今年就会成为新的标准，同时借助一些编译器（比如babel），我们早已经可以在正式环境中使用它了。另外，TypeScript 在去年和AtScript 合并后发布的 1.5 版本，就已经支持装饰器语法了。基于 TypeScript 开发的 An">
<meta property="og:type" content="article">
<meta property="og:title" content="JavaScript 中的装饰器是什么？">
<meta property="og:url" content="http://codersir.github.io/2016/01/31/what-is-decorator-in-javascript/index.html">
<meta property="og:site_name" content="Coder Sir">
<meta property="og:description" content="装饰器是 ES7（也就是ES2016）的提案，虽然听着感觉好像还有点遥远，毕竟 ES6 还没有走多久呢，但实际上，2016年已经到来，也就是说，ES7 的提案今年就会成为新的标准，同时借助一些编译器（比如babel），我们早已经可以在正式环境中使用它了。另外，TypeScript 在去年和AtScript 合并后发布的 1.5 版本，就已经支持装饰器语法了。基于 TypeScript 开发的 An">
<meta property="og:updated_time" content="2016-05-29T18:17:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JavaScript 中的装饰器是什么？">
<meta name="twitter:description" content="装饰器是 ES7（也就是ES2016）的提案，虽然听着感觉好像还有点遥远，毕竟 ES6 还没有走多久呢，但实际上，2016年已经到来，也就是说，ES7 的提案今年就会成为新的标准，同时借助一些编译器（比如babel），我们早已经可以在正式环境中使用它了。另外，TypeScript 在去年和AtScript 合并后发布的 1.5 版本，就已经支持装饰器语法了。基于 TypeScript 开发的 An">
  
    <link rel="alternative" href="/atom.xml" title="Coder Sir" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>
<body>
  <header class="sidebar" role="header">
    
      <div class="sidebar__profile">
	<a class="sidebar__profile-link" href="/">
		<figure>
			<img class="sidebar__profile-img" src="/image/site/gravatar.png" alt="">
		</figure>
	</a>
	<h1 class="sidebar__profile-name">Codersir</h1>
	<div class="sidebar__profile-bio">
		<p>Focus on the web development. <br>Insterested in JavaScript, Angular, React and Node.js.</p>
	</div>
</div>
<nav class="sidebar__profile-nav" role="nav">
	<ul>
	
		<li>
			<a href="/archives">Archives</a>
		</li>
	
		<li>
			<a href="/resume">Resume</a>
		</li>
	
		<li>
			<a href="/tags">Tags</a>
		</li>
	
	</ul>
</nav>
<aside class="sidebar__profile-social" role="social">
	
		
			
			<a class="social-github" target="_blank" href="http://github.com/xuhong">
				<span class="fa fa-github"></span>
			</a>
			
		
			
		
			
		
			
			<a class="social-instagram" target="_blank" href="http://instagram.com/codersir">
				<span class="fa fa-instagram"></span>
			</a>
			
		
			
			<a class="social-rss" target="_blank" href="/atom.xml">
				<span class="fa fa-rss"></span>
			</a>
			
		
	
</aside>

    
  </header>
  <main class="main" role="main">
    <article id="post-what-is-decorator-in-javascript" class="article article--type-post" itemscope itemprop="blogPost">
  <div class="article__inner">
    
    
      <header class="article__header">
        
  
    <h1 class="article__title" itemprop="name">
      JavaScript 中的装饰器是什么？
    </h1>
  

      </header>
      <div class="article__meta">
        <a href="https://github.com/codersir/codersir.github.io/tree/master/source/_posts/what-is-decorator-in-javascript.md" class="article__meta-edit">
	<i class="fa fa-github"></i> Edit this page on GitHub
</a>

        
	<time class="article__meta-date" datetime="2016-01-30T16:36:01.000Z" itemprop="datePublished">Jan 1, 2016</time>

      </div>
    
    <div class="article__entry" itemprop="articleBody">
      
        <p>装饰器是 ES7（也就是ES2016）的提案，虽然听着感觉好像还有点遥远，毕竟 ES6 还没有走多久呢，但实际上，2016年已经到来，也就是说，ES7 的提案今年就会成为新的标准，同时借助一些编译器（比如babel），我们早已经可以在正式环境中使用它了。另外，TypeScript 在去年和<br>AtScript 合并后发布的 1.5 版本，就已经支持装饰器语法了。基于 TypeScript 开发的 Angular2 里面也大量的使用了装饰器。</p>
<h2 id="什么是装饰器"><a href="#什么是装饰器" class="headerlink" title="什么是装饰器"></a>什么是装饰器</h2><p>用提案的描述来说，装饰器是：</p>
<blockquote>
<p>一个求值结果为函数的表达式，接受目标对象、名称和装饰器描述作为参数，可选地返回一个装饰器描述来安装到目标对象上。</p>
</blockquote>
<a id="more"></a>
<h2 id="怎么使用装饰器"><a href="#怎么使用装饰器" class="headerlink" title="怎么使用装饰器"></a>怎么使用装饰器</h2><p>TypeScript 已经完整的支持了 ES7 装饰器的接口，通过 <a href="https://github.com/Microsoft/TypeScript/blob/master/src/lib/core.d.ts#L1254" target="_blank" rel="external">TypeScript 装饰器的实现</a>，来进一步掌握装饰器的使用：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">declare</span> <span class="keyword">type</span> ClassDecorator = &lt;TFunction extends <span class="keyword">Function</span>&gt;(target: TFunction) =&gt; TFunction | <span class="built_in">void</span>;</div><div class="line"><span class="keyword">declare</span> <span class="keyword">type</span> PropertyDecorator = (target: <span class="keyword">Object</span>, propertyKey: <span class="keyword">string</span> | symbol) =&gt; <span class="built_in">void</span>;</div><div class="line"><span class="keyword">declare</span> <span class="keyword">type</span> MethodDecorator = &lt;T&gt;(target: <span class="keyword">Object</span>, propertyKey: <span class="keyword">string</span> | symbol, <span class="keyword">descriptor</span>: TypedPropertyDescriptor&lt;T&gt;) =&gt; TypedPropertyDescriptor&lt;T&gt; | <span class="built_in">void</span>;</div><div class="line"><span class="keyword">declare</span> <span class="keyword">type</span> ParameterDecorator = (target: <span class="keyword">Object</span>, propertyKey: <span class="keyword">string</span> | symbol, parameterIndex: <span class="built_in">number</span>) =&gt; <span class="built_in">void</span>;</div></pre></td></tr></table></figure>
<p>通过上面的代码可以知道，装饰器可以用来注解<strong>类</strong>，<strong>属性</strong>，<strong>方法</strong>和<strong>参数</strong>，下面分别看不同情况下如何使用和实现。</p>
<h3 id="装饰类"><a href="#装饰类" class="headerlink" title="装饰类"></a>装饰类</h3><p>TypeScript 类装饰器接口如下：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">declare <span class="keyword">type</span> ClassDecorator = &lt;TFunction <span class="keyword">extends</span> <span class="function"><span class="keyword">Function</span></span>&gt;(<span class="keyword">target</span>: TFunction) =&gt; TFunction | void;</div></pre></td></tr></table></figure>
<p>通过接口可以知道类装饰器接受一个目标函数作为参数，考虑下面简单的类：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hero</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> name: string</div><div class="line">    <span class="keyword">public</span> power: string</div><div class="line"></div><div class="line">    <span class="keyword">constructor</span>(name: string, power: string) &#123;</div><div class="line">        <span class="keyword">this</span>.name = name</div><div class="line">        <span class="keyword">this</span>.power = power</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    showPower()&#123;</div><div class="line">    	<span class="keyword">return</span> `$&#123;<span class="keyword">this</span>.name&#125; has special power: $&#123;<span class="keyword">this</span>.power&#125;`</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>把上面的代码编译为 JavaScript，得到：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Hero = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Hero</span><span class="params">(name, power)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.power = power;</div><div class="line">    &#125;</div><div class="line">    Hero.prototype.showPower = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name + <span class="string">" has special power: "</span> + <span class="keyword">this</span>.power;</div><div class="line">    &#125;;</div><div class="line">    <span class="keyword">return</span> Hero;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<p>下面给 <code>Hero</code> 类添加一个 <code>@logClass</code> 的装饰器：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@logClass</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hero</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> name: string</div><div class="line">    <span class="keyword">public</span> power: string</div><div class="line"></div><div class="line">    <span class="keyword">constructor</span>(name: string, power: string) &#123;</div><div class="line">        <span class="keyword">this</span>.name = name</div><div class="line">        <span class="keyword">this</span>.power = power</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    showPower()&#123;</div><div class="line">    	<span class="keyword">return</span> `$&#123;<span class="keyword">this</span>.name&#125; has special power: $&#123;<span class="keyword">this</span>.power&#125;`</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重新编译成 JavaScript ：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Hero = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Hero</span><span class="params">(name, power)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.power = power;</div><div class="line">    &#125;</div><div class="line">    Hero.prototype.showPower = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name + <span class="string">" has "</span> + <span class="keyword">this</span>.power;</div><div class="line">    &#125;;</div><div class="line">    Hero = __decorate([</div><div class="line">        logClass</div><div class="line">    ], Hero);</div><div class="line">    <span class="keyword">return</span> Hero;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<p>上面的代码在返回<code>Hero</code>构造函数之前，将它作为参数传给了<code>__decorate</code>函数，那<code>__decorate</code>函数做了什么？看编译后的 JavaScript 代码，可以看到该函数实现如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 保证上下文中只有一个 __decorate 函数，不会被反复重载</span></div><div class="line"><span class="keyword">var</span> __decorate = (<span class="keyword">this</span> &amp;&amp; <span class="keyword">this</span>.__decorate) || <span class="function"><span class="keyword">function</span>(<span class="params">decorators, target, key, desc</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> c = <span class="built_in">arguments</span>.length,</div><div class="line">    	<span class="comment">// 装饰类的时候，__decorate 函数接受两个参数，所以 r = target，也就是上文的构造函数 Hero</span></div><div class="line">        r = c &lt; <span class="number">3</span> ? target : desc === <span class="literal">null</span> ? desc = <span class="built_in">Object</span>.getOwnPropertyDescriptor(target, key) : desc,</div><div class="line">        d;</div><div class="line">    <span class="comment">// 这是另外一个 ES7 API 了，先不管，看 fallback 方案</span></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">Reflect</span> === <span class="string">"object"</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">Reflect</span>.decorate === <span class="string">"function"</span>) r = <span class="built_in">Reflect</span>.decorate(decorators, target, key, desc);</div><div class="line">    <span class="keyword">else</span></div><div class="line">    	<span class="comment">// 从右向左依次执行 decorator 函数，对 class 而言，相当于 decorators.reduceRight(function(o, d)&#123; return (d &amp;&amp; d(r)) || o &#125;, r)</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = decorators.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</div><div class="line">            <span class="keyword">if</span> (d = decorators[i]) r = (c &lt; <span class="number">3</span> ? d(r) : c &gt; <span class="number">3</span> ? d(target, key, r) : d(target, key)) || r;</div><div class="line">    最后返回 r</div><div class="line">    <span class="keyword">return</span> c &gt; <span class="number">3</span> &amp;&amp; r &amp;&amp; <span class="built_in">Object</span>.defineProperty(target, key, r), r;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>__decorate</code> 函数体其实很简单，主要是进行一些条件判断，根据传入参数个数的不同判断装饰器的类型，并执行相关的装饰器函数。</p>
<p>需要注意的两个函数是：</p>
<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptor" target="_blank" rel="external">Object.getOwnPropertyDescriptor</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty" target="_blank" rel="external">Object.defineProperty</a><br>第一个函数是获取对象自有属性的描述符，第二是添加或修改对象的自有属性，具体用法查看 MDN。</li>
</ul>
<p>知道装饰器装饰类是如何进行工作后，下面来完善 <code>@logClass</code> 装饰器。通过类装饰器接口可以知道，它接受一个函数作为参数，并返回函数。 <code>@logClass</code> 装饰器的目的是，在每次英雄被派出去拯救世界的时候，<br>记录下来是哪个英雄出去了，为他祈祷，实现如下：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">logClass</span><span class="params">(target: any)</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">// 保存原始构造器</span></div><div class="line">  <span class="keyword">var</span> original = target;</div><div class="line"></div><div class="line">  <span class="comment">// 工具函数，生成类的实例</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">construct</span><span class="params">(constructor, args)</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> c : any = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> constructor.apply(<span class="keyword">this</span>, args);</div><div class="line">    &#125;</div><div class="line">    c.prototype = constructor.prototype;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> c();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 添加行为到构造器调用时</span></div><div class="line">  <span class="keyword">var</span> f : any = <span class="function"><span class="keyword">function</span> <span class="params">(<span class="rest_arg">...args</span>)</span> </span>&#123;</div><div class="line">    console.log(<span class="string">"God bless "</span> + args[<span class="number">0</span>]); </div><div class="line">    <span class="keyword">return</span> construct(original, args);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 复制原始构造器的原型</span></div><div class="line">  f.prototype = original.prototype;</div><div class="line"></div><div class="line">  <span class="comment">// 返回新的构造器</span></div><div class="line">  <span class="keyword">return</span> f;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码已经清晰的注释了，就不添加更多的说明了，可以看到，类装饰器就是<strong>给构造函数添加额外的动作</strong>。现在当派出一个新的英雄之前，我们会为他祈福：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> batman = <span class="keyword">new</span> Hero(<span class="string">'batman'</span>, <span class="string">'fly'</span>)</div><div class="line"><span class="comment">// God bless batman</span></div><div class="line"></div><div class="line">batman <span class="keyword">instanceof</span> Hero</div><div class="line"><span class="comment">// true</span></div></pre></td></tr></table></figure>
<p><a href="http://www.typescriptlang.org/Playground#src=%40logClass%0D%0Aclass%20Hero%20%7B%0D%0A%20%20%20%20public%20name%3A%20string%3B%0D%0A%20%20%20%20public%20power%3A%20string%3B%0D%0A%0D%0A%20%20%20%20constructor(name%3A%20string%2C%20power%3A%20string)%20%7B%0D%0A%20%20%20%20%20%20%20%20this.name%20%3D%20name%0D%0A%20%20%20%20%20%20%20%20this.power%20%3D%20power%0D%0A%20%20%20%20%7D%0D%0A%0D%0A%20%20%20%20showPower()%7B%0D%0A%20%20%20%20%09return%20%60%24%7Bthis.name%7D%20has%20special%20power%3A%20%24%7Bthis.power%7D%60%0D%0A%20%20%20%20%7D%0D%0A%7D%0D%0A%0D%0Afunction%20logClass(target%3A%20any)%20%7B%0D%0A%0D%0A%20%20%2F%2F%20%E4%BF%9D%E5%AD%98%E5%8E%9F%E5%A7%8B%E6%9E%84%E9%80%A0%E5%99%A8%0D%0A%20%20var%20original%20%3D%20target%3B%0D%0A%0D%0A%20%20%2F%2F%20%E5%B7%A5%E5%85%B7%E5%87%BD%E6%95%B0%EF%BC%8C%E7%94%9F%E6%88%90%E7%B1%BB%E7%9A%84%E5%AE%9E%E4%BE%8B%0D%0A%20%20function%20construct(constructor%2C%20args)%20%7B%0D%0A%20%20%20%20var%20c%20%3A%20any%20%3D%20function%20()%20%7B%0D%0A%20%20%20%20%20%20return%20constructor.apply(this%2C%20args)%3B%0D%0A%20%20%20%20%7D%0D%0A%20%20%20%20c.prototype%20%3D%20constructor.prototype%3B%0D%0A%20%20%20%20return%20new%20c()%3B%0D%0A%20%20%7D%0D%0A%0D%0A%20%20%2F%2F%20%E6%B7%BB%E5%8A%A0%E8%A1%8C%E4%B8%BA%E5%88%B0%E6%9E%84%E9%80%A0%E5%99%A8%E8%B0%83%E7%94%A8%E6%97%B6%0D%0A%20%20var%20f%20%3A%20any%20%3D%20function%20(...args)%20%7B%0D%0A%20%20%20%20console.log(%22God%20bless%20%22%20%2B%20args%5B0%5D)%3B%20%0D%0A%20%20%20%20return%20construct(original%2C%20args)%3B%0D%0A%20%20%7D%0D%0A%0D%0A%20%20%2F%2F%20%E5%A4%8D%E5%88%B6%E5%8E%9F%E5%A7%8B%E6%9E%84%E9%80%A0%E5%99%A8%E7%9A%84%E5%8E%9F%E5%9E%8B%0D%0A%20%20f.prototype%20%3D%20original.prototype%3B%0D%0A%0D%0A%20%20%2F%2F%20%E8%BF%94%E5%9B%9E%E6%96%B0%E7%9A%84%E6%9E%84%E9%80%A0%E5%99%A8%0D%0A%20%20return%20f%3B%0D%0A%7D%0D%0Anew%20Hero('batman'%2C%20'fly')" target="_blank" rel="external">play</a></p>
<h3 id="装饰属性"><a href="#装饰属性" class="headerlink" title="装饰属性"></a>装饰属性</h3><p>TypeScript 属性装饰器接口如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">declare</span> <span class="keyword">type</span> PropertyDecorator = (target: <span class="keyword">Object</span>, propertyKey: <span class="keyword">string</span> | symbol) =&gt; <span class="built_in">void</span>;</div></pre></td></tr></table></figure>
<p>由接口可以知道，属性装饰器接受两个参数，一个是目标对象，另一个是属性名称，没有返回值。<br>继续使用上面 Hero 类，这次给 <code>power</code> 属性加上 <code>@logProperty</code> 属性装饰器，在给英雄使用超能力的时候，添加 Bgm，代码如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hero</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> name: string</div><div class="line">    <span class="meta">@logProperty</span></div><div class="line">    <span class="keyword">public</span> power: string</div><div class="line"></div><div class="line">    <span class="keyword">constructor</span>(name:string, power:string)&#123;</div><div class="line">        <span class="keyword">this</span>.name = name</div><div class="line">        <span class="keyword">this</span>.power = power</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    showPower()&#123;</div><div class="line">        <span class="keyword">return</span> `$&#123;<span class="keyword">this</span>.name&#125; has special power: $&#123;<span class="keyword">this</span>.power&#125;`</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>同样，编译成 JavaScript 后得到：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Hero = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Hero</span><span class="params">(name, power)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.power = power;</div><div class="line">    &#125;</div><div class="line">    Hero.prototype.showPower = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name + <span class="string">" has special power: "</span> + <span class="keyword">this</span>.power;</div><div class="line">    &#125;;</div><div class="line">    __decorate([</div><div class="line">        logProperty</div><div class="line">    ], Hero.prototype, <span class="string">"power"</span>, <span class="keyword">void</span> <span class="number">0</span>);</div><div class="line">    <span class="keyword">return</span> Hero;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<p>此处再次用到了 <code>__decorate</code> 函数，但传入参数的个数是3个，装饰器，构造函数的原型和属性名，所以精简一下 <code>__decorator</code> 函数，得到属性装饰器的版本：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> __decorate = (<span class="keyword">this</span> &amp;&amp; <span class="keyword">this</span>.__decorate) || <span class="function"><span class="keyword">function</span>(<span class="params">decorators, target, key, desc</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> c = <span class="built_in">arguments</span>.length,</div><div class="line">    	r = <span class="built_in">Object</span>.getOwnPropertyDescriptor(target, key)</div><div class="line">        d;</div><div class="line">    <span class="comment">// 从右向左依次执行 decorator 函数，相当于 decorators.reduceRight(function(o, d)&#123; return (d &amp;&amp; d(target, key) || o &#125;, r)</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = decorators.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</div><div class="line">        <span class="keyword">if</span> (d = decorators[i]) r = d(target, key) || r;</div><div class="line">    <span class="keyword">return</span> r;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>另外对比类装饰器，可以看到这次没有用 <code>__decorate</code> 函数的返回值覆盖原始的类，属性装饰器的接口是没有返回值（=&gt;void)的。</p>
<p>现在知道了属性装饰器接受构造器的原型和属性名作为参数，并且没有返回值，下面开始着手实现 <code>@logProperty</code> 装饰器：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">logProperty</span>(<span class="params">target: <span class="built_in">any</span>, key: <span class="built_in">string</span></span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">// 存储属性值</span></div><div class="line">  <span class="keyword">var</span> _val = <span class="keyword">this</span>[key];</div><div class="line"></div><div class="line">  <span class="comment">// 获取属性</span></div><div class="line">  <span class="keyword">var</span> getter = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">`此处应有 Bgm <span class="subst">$&#123;_val&#125;</span>`</span>);</div><div class="line">    <span class="keyword">return</span> _val;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="comment">// 设置属性</span></div><div class="line">  <span class="keyword">var</span> setter = <span class="function"><span class="keyword">function</span> (<span class="params">newVal</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">`切换特技 <span class="subst">$&#123;newVal&#125;</span>`</span>);</div><div class="line">    _val = newVal;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="comment">// 删除属性并重新设置该属性</span></div><div class="line">  <span class="keyword">if</span> (<span class="keyword">delete</span> <span class="keyword">this</span>[key]) &#123;</div><div class="line"></div><div class="line">    <span class="comment">// 创建一个新的属性，使用我们自定义的存储器</span></div><div class="line">    <span class="built_in">Object</span>.defineProperty(target, key, &#123;</div><div class="line">      <span class="keyword">get</span>: getter,</div><div class="line">      <span class="keyword">set</span>: setter,</div><div class="line">      enumerable: <span class="literal">true</span>,</div><div class="line">      configurable: <span class="literal">true</span></div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>// todo<br>// this在此处的使用需要进一步说明，为什么 this 的上下文是构造器原型？</p>
<p>现在，英雄放大招和切换大招的时候，我们就会看到控制台输出了：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">var</span> batman = new Hero(<span class="string">'batman'</span>, <span class="string">'fly'</span>)</div><div class="line"><span class="comment">// 切换特技 fly</span></div><div class="line">batman.showPower()</div><div class="line"><span class="comment">// 此处应有 Bgm</span></div><div class="line">batman<span class="selector-class">.power</span> = <span class="string">'doublekill'</span></div><div class="line"><span class="comment">// 切换特技 doublekill</span></div></pre></td></tr></table></figure>
<p><a href="http://www.typescriptlang.org/Playground#src=class%20Hero%20%7B%0D%0A%20%20%20%20public%20name%3A%20string%0D%0A%20%20%20%20%40logProperty%0D%0A%20%20%20%20public%20power%3A%20string%0D%0A%0D%0A%20%20%20%20constructor(name%3Astring%2C%20power%3Astring)%7B%0D%0A%20%20%20%20%20%20%20%20this.name%20%3D%20name%0D%0A%20%20%20%20%20%20%20%20this.power%20%3D%20power%0D%0A%20%20%20%20%7D%0D%0A%0D%0A%20%20%20%20showPower()%7B%0D%0A%20%20%20%20%20%20%20%20return%20%60%24%7Bthis.name%7D%20has%20special%20power%3A%20%24%7Bthis.power%7D%60%0D%0A%20%20%20%20%7D%0D%0A%7D%0D%0A%0D%0Afunction%20logProperty(target%3A%20any%2C%20key%3A%20string)%20%7B%0D%0A%0D%0A%20%20%2F%2F%20%E5%AD%98%E5%82%A8%E5%B1%9E%E6%80%A7%E5%80%BC%0D%0A%20%20var%20_val%20%3D%20this%5Bkey%5D%3B%0D%0A%0D%0A%20%20%2F%2F%20%E8%8E%B7%E5%8F%96%E5%B1%9E%E6%80%A7%0D%0A%20%20var%20getter%20%3D%20function%20()%20%7B%0D%0A%20%20%20%20console.log(%60%E6%AD%A4%E5%A4%84%E5%BA%94%E6%9C%89%20Bgm%20%24%7B_val%7D%60)%3B%0D%0A%20%20%20%20return%20_val%3B%0D%0A%20%20%7D%3B%0D%0A%0D%0A%20%20%2F%2F%20%E8%AE%BE%E7%BD%AE%E5%B1%9E%E6%80%A7%0D%0A%20%20var%20setter%20%3D%20function%20(newVal)%20%7B%0D%0A%20%20%20%20console.log(%60%E5%88%87%E6%8D%A2%E7%89%B9%E6%8A%80%20%24%7BnewVal%7D%60)%3B%0D%0A%20%20%20%20_val%20%3D%20newVal%3B%0D%0A%20%20%7D%3B%0D%0A%0D%0A%20%20%2F%2F%20%E5%88%A0%E9%99%A4%E5%B1%9E%E6%80%A7%E5%B9%B6%E9%87%8D%E6%96%B0%E8%AE%BE%E7%BD%AE%E8%AF%A5%E5%B1%9E%E6%80%A7%0D%0A%20%20if%20(delete%20this%5Bkey%5D)%20%7B%0D%0A%0D%0A%20%20%20%20%2F%2F%20%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%96%B0%E7%9A%84%E5%B1%9E%E6%80%A7%EF%BC%8C%E4%BD%BF%E7%94%A8%E6%88%91%E4%BB%AC%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9A%84%E5%AD%98%E5%82%A8%E5%99%A8%0D%0A%20%20%20%20Object.defineProperty(target%2C%20key%2C%20%7B%0D%0A%20%20%20%20%20%20get%3A%20getter%2C%0D%0A%20%20%20%20%20%20set%3A%20setter%2C%0D%0A%20%20%20%20%20%20enumerable%3A%20true%2C%0D%0A%20%20%20%20%20%20configurable%3A%20true%0D%0A%20%20%20%20%7D)%3B%0D%0A%20%20%7D%0D%0A%7D%0D%0A%0D%0Avar%20hero%20%3D%20new%20Hero('batman'%2C'fly')%0D%0Ahero.showPower()%0D%0Ahero.power%20%3D%20'doublekill'" target="_blank" rel="external">play</a></p>
<h3 id="装饰方法"><a href="#装饰方法" class="headerlink" title="装饰方法"></a>装饰方法</h3><p>TypeScript 属性方法接口如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">declare</span> <span class="keyword">type</span> MethodDecorator = &lt;T&gt;(target: <span class="keyword">Object</span>, propertyKey: <span class="keyword">string</span> | symbol, <span class="keyword">descriptor</span>: TypedPropertyDescriptor&lt;T&gt;) =&gt; TypedPropertyDescriptor&lt;T&gt; | <span class="built_in">void</span>;</div></pre></td></tr></table></figure>
<p>方法装饰器接受三个参数，返回属性描述符或者没有返回。这次我们装饰 <code>showPower</code>方法，给它添加 <code>@logMethod</code> 装饰器：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hero</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> name: string</div><div class="line">    <span class="keyword">public</span> power: string</div><div class="line"></div><div class="line">    <span class="keyword">constructor</span>(name:string, power:string)&#123;</div><div class="line">        <span class="keyword">this</span>.name = name</div><div class="line">        <span class="keyword">this</span>.power = power</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="meta">@logMethod</span></div><div class="line">    showPower()&#123;</div><div class="line">        <span class="keyword">return</span> `$&#123;<span class="keyword">this</span>.name&#125; has special power: $&#123;<span class="keyword">this</span>.power&#125;`</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编译为 JavaScript 得到：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Hero = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Hero</span><span class="params">(name, power)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.power = power;</div><div class="line">    &#125;</div><div class="line">    Hero.prototype.showPower = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.name + <span class="string">" has special power: "</span> + <span class="keyword">this</span>.power;</div><div class="line">    &#125;;</div><div class="line">    __decorate([</div><div class="line">        logMethod</div><div class="line">    ], Hero.prototype, <span class="string">"showPower"</span>, <span class="literal">null</span>);</div><div class="line">    <span class="keyword">return</span> Hero;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<p>此时 <code>__decoreate</code> 函数去掉条件判断得到：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> __decorate = (<span class="keyword">this</span> &amp;&amp; <span class="keyword">this</span>.__decorate) || <span class="function"><span class="keyword">function</span>(<span class="params">decorators, target, key, desc</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> c = <span class="built_in">arguments</span>.length,</div><div class="line">        r = desc || <span class="built_in">Object</span>.getOwnPropertyDescriptor(target, key),</div><div class="line">        d;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = decorators.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</div><div class="line">        <span class="keyword">if</span> (d = decorators[i]) r = d(target, key, r) || r;</div><div class="line">    <span class="keyword">return</span> r &amp;&amp; <span class="built_in">Object</span>.defineProperty(target, key, r), r;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>下面我们来实现 <code>@logMethod</code> 装饰器：<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">logMethod</span><span class="params">(target:any, key:string, descriptor: object)</span></span>&#123;</div><div class="line">  <span class="keyword">var</span> originalMethod = descriptor.value; </div><div class="line"></div><div class="line">  descriptor.value =  <span class="function"><span class="keyword">function</span> <span class="params">(<span class="rest_arg">...args</span>: any[])</span> </span>&#123;</div><div class="line">      <span class="keyword">var</span> a = args.map(a =&gt; JSON.stringify(a)).join();</div><div class="line">      <span class="keyword">var</span> result = originalMethod.apply(<span class="keyword">this</span>, args);</div><div class="line">      <span class="keyword">var</span> r = JSON.stringify(result);</div><div class="line">      console.log(`Call: $&#123;key&#125;($&#123;a&#125;) =&gt; $&#123;r&#125;`);</div><div class="line">      <span class="keyword">return</span> result;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> descriptor;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><a href="http://www.typescriptlang.org/Playground#src=class%20Hero%20%7B%0D%0A%20%20%20%20public%20name%3A%20string%3B%0D%0A%20%20%20%20public%20power%3A%20string%3B%0D%0A%0D%0A%20%20%20%20constructor(name%3A%20string%2C%20power%3A%20string)%20%7B%0D%0A%20%20%20%20%20%20%20%20this.name%20%3D%20name%0D%0A%20%20%20%20%20%20%20%20this.power%20%3D%20power%0D%0A%20%20%20%20%7D%0D%0A%0D%0A%20%20%20%20%40logMethod%0D%0A%20%20%20%20showPower()%20%7B%0D%0A%20%20%20%20%20%20%20%20return%20%60%24%7Bthis.name%7D%20has%20special%20power%3A%20%24%7Bthis.power%7D%60%0D%0A%20%20%20%20%7D%0D%0A%7D%0D%0A%0D%0Afunction%20logMethod(target%3A%20Object%2C%20key%3Astring%2C%20descriptor%3A%20TypedPropertyDescriptor%3Cany%3E)%7B%0D%0A%20%20var%20originalMethod%20%3D%20descriptor.value%3B%20%0D%0A%0D%0A%20%20%2F%2Fediting%20the%20descriptor%2Fvalue%20parameter%0D%0A%20%20descriptor.value%20%3D%20%20function%20(...args%3A%20any%5B%5D)%20%7B%0D%0A%20%20%20%20%20%20var%20a%20%3D%20args.map(a%20%3D%3E%20JSON.stringify(a)).join()%3B%0D%0A%20%20%20%20%20%20%2F%2F%20note%20usage%20of%20originalMethod%20here%0D%0A%20%20%20%20%20%20var%20result%20%3D%20originalMethod.apply(this%2C%20args)%3B%0D%0A%20%20%20%20%20%20var%20r%20%3D%20JSON.stringify(result)%3B%0D%0A%20%20%20%20%20%20console.log(%60Call%3A%20%24%7Bkey%7D(%24%7Ba%7D)%20%3D%3E%20%24%7Br%7D%60)%3B%0D%0A%20%20%20%20%20%20return%20result%3B%0D%0A%20%20%7D%0D%0A%0D%0A%20%20%2F%2F%20return%20edited%20descriptor%20as%20opposed%20to%20overwriting%20%0D%0A%20%20%2F%2F%20the%20descriptor%20by%20returning%20a%20new%20descriptor%0D%0A%20%20return%20descriptor%3B%0D%0A%7D%0D%0A%0D%0Anew%20Hero('batman'%2C%20'fly').showPower()" target="_blank" rel="external">play</a></p>
<h3 id="装饰参数"><a href="#装饰参数" class="headerlink" title="装饰参数"></a>装饰参数</h3><p>TypeScript 参数装饰器接口如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">declare</span> <span class="keyword">type</span> ParameterDecorator = (target: <span class="keyword">Object</span>, propertyKey: <span class="keyword">string</span> | symbol, parameterIndex: <span class="built_in">number</span>) =&gt; <span class="built_in">void</span>;</div></pre></td></tr></table></figure>
<p>参数装饰器也接受三个参数：</p>
<ul>
<li>对象</li>
<li>属性名</li>
<li>参数索引</li>
</ul>
<p>我们给 <code>showPower</code> 函数添加一个表示连击次数的参数，并用 <code>@logParameter</code> 装饰它：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">class</span> Hero &#123;</div><div class="line">    public <span class="built_in">name</span>: <span class="built_in">string</span></div><div class="line">    public power: <span class="built_in">string</span></div><div class="line"></div><div class="line">    constructor(<span class="built_in">name</span>:<span class="built_in">string</span>, power:<span class="built_in">string</span>)&#123;</div><div class="line">        this.<span class="built_in">name</span> = <span class="built_in">name</span></div><div class="line">        this.power = power</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    showPower(@logParameter <span class="built_in">time</span>:<span class="built_in">number</span>)&#123;</div><div class="line"><span class="built_in">        return</span> `$&#123;<span class="built_in">time</span>&#125; <span class="keyword">times</span> power damage`</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>编译为 JavaScript 得到：</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> Hero = (<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Hero</span><span class="params">(name, power)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.name = name;</div><div class="line">        <span class="keyword">this</span>.power = power;</div><div class="line">    &#125;</div><div class="line">    Hero.prototype.showPower = <span class="function"><span class="keyword">function</span> <span class="params">(time)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> time + <span class="string">" times power damage"</span>;</div><div class="line">    &#125;;</div><div class="line">    __decorate([</div><div class="line">        __param(<span class="number">0</span>, logParamater)</div><div class="line">    ], Hero.prototype, <span class="string">"showPower"</span>, <span class="literal">null</span>);</div><div class="line">    <span class="keyword">return</span> Hero;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<p>观察 <code>__decorate</code> 函数，我们发现这里调用了另外一个 <code>__param</code> 函数，<code>__param</code> 函数实现如下：<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> __param = (<span class="keyword">this</span> &amp;&amp; <span class="keyword">this</span>.__param) || <span class="function"><span class="keyword">function</span> <span class="params">(paramIndex, decorator)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(target, key)</span> </span>&#123; decorator(target, key, paramIndex); &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p><code>__param</code> 函数接受两个参数，参数索引和装饰器函数，返回一个装饰器函数的包装函数。</p>
<p>简化后的 <code>__decorate</code> 函数和上面的方法装饰器得到的一样。</p>
<p>下面我们来实现 <code>@logParameter</code> 装饰器函数：</p>
<figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span></span> logParameter(<span class="keyword">target</span>: Object, key : string, <span class="built_in">index</span> : <span class="keyword">number</span>) &#123;</div><div class="line">  var metadataKey = `log_$&#123;key&#125;_parameters`;</div><div class="line">  <span class="keyword">if</span> (Array.isArray(<span class="keyword">target</span>[metadataKey])) &#123;</div><div class="line">    <span class="keyword">target</span>[metadataKey].push(<span class="built_in">index</span>);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span> &#123; </div><div class="line">    <span class="keyword">target</span>[metadataKey] = [<span class="built_in">index</span>];</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>logParameter</code> 函数在 <code>Hero.prototype</code> 上添加了一个属性 <code>log_showPower_parameters</code> 用来记录<code>showPower</code>函数被装饰参数的索引。</p>
<p>参数装饰器不支持改变构造器、方法或属性的行为，它只应该用来生成一些元数据。</p>
<h3 id="给装饰器传入参数"><a href="#给装饰器传入参数" class="headerlink" title="给装饰器传入参数"></a>给装饰器传入参数</h3><p>我们可以通过装饰器构造函数来创建可配置的装饰器。下面创建一个可配置的类装饰器：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@logClassWithArgs</span>(&#123;<span class="string">sex:</span> <span class="string">"male"</span>&#125;)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Hero</span> &#123;</span> </div><div class="line">  <span class="keyword">public</span> <span class="string">name:</span> string;</div><div class="line"></div><div class="line">  <span class="comment">// ...</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">function logClassWidthArgs(<span class="string">options:</span> Object)&#123;</div><div class="line">  <span class="keyword">return</span> (<span class="string">target:</span> Object) =&gt;&#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>装饰器非常的强大，我们可以使用装饰器大量的简化代码，Angular2 中也大量使用了装饰器，比如 <code>@Component()</code>、<code>@view()</code>、<code>@Input()</code>、<code>@Output()</code>、<code>@Injectable()</code>等。后面<br>将会深入写 Angular2 中的装饰器。</p>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><ul>
<li><a href="https://github.com/wycats/javascript-decorators" target="_blank" rel="external">javascript-decorators提案</a>以及 <a href="https://github.com/xuhong/javascript-decorators" target="_blank" rel="external">我的翻译版本</a></li>
<li><a href="http://blog.wolksoftware.com/decorators-reflection-javascript-typescript" target="_blank" rel="external">decorators-reflection-javascript-typescript</a></li>
<li><a href="http://stackoverflow.com/questions/29775830/how-to-implement-a-typescript-decorator/29837695#29837695" target="_blank" rel="external">How to implement a typescript decorator?</a></li>
<li><a href="https://github.com/GoogleChrome/samples/tree/gh-pages/decorators-es7/read-write" target="_blank" rel="external">Google ES7 decorators sample</a></li>
</ul>

        <br>
        <p>--EOF--</p>
        <p>
          <small>于 
            
	<time class="article__meta-date" datetime="2016-01-30T16:36:01.000Z" itemprop="datePublished">Jan 1, 2016 00:36:01</time>
 发表
            
            
            ，并被添加标签「
             
	<a class="article_meta-tag" title="2篇文章" href="http://codersir.github.io/tags/typescript/">typescript</a>
 
	<a class="article_meta-tag" title="1篇文章" href="http://codersir.github.io/tags/es2016/">es2016</a>
 
	<a class="article_meta-tag" title="1篇文章" href="http://codersir.github.io/tags/decorator/">decorator</a>

            」
            
            
             
              ，更新于
              
	<time class="article__meta-updated" datetime="2016-05-29T18:17:32.000Z" itemprop="datePublished">May 5, 2016 02:17:32</time>

            。
          </small>
      
    </div>
  </div>
  
    <section id="comments">
      <h1 class="title" href="http://codersir.github.io/2016/01/31/what-is-decorator-in-javascript/#disqus_thread">Comments</h1>
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      </div>
    </section>
  
  
    
<nav class="article__nav">
  
    <a href="/2016/03/13/dive-into-zone/" class="article__nav-newer article__nav-link-wrap">
      <strong class="article__nav-caption">Newer</strong>
      <div class="article__nav-title">
        
          理解 Zone 的实现机制
        
      </div>
    </a>
  
  
    <a href="/2016/01/25/dive-into-redux/" class="article__nav-older article__nav-link-wrap">
      <strong class="article__nav-caption">Older</strong>
      <div class="article__nav-title">深入学习 Redux</div>
    </a>
  
</nav>

  
</article>


<script>
  var disqus_shortname = 'codsirblog';
  var disqus_loaded = false;
  var body = document.body;
  var html = document.documentElement;
  var clientHeight = html.clientHeight
  var pageHeight = Math.max(body.scrollHeight,body.offsetHeight,html.clientHeight, html.scrollHeight, html.offsetHeight)

  
  var disqus_url = 'http://codersir.github.io/2016/01/31/what-is-decorator-in-javascript/';
  

  if(clientHeight == pageHeight){
    loadDisqus()
    disqus_loaded = true
  }
  
  document.addEventListener('scroll', function(e){
    if(disqus_loaded){
      return
    }else{
      var scrollTop = body.scrollTop;
      if(scrollTop + clientHeight + 100 > pageHeight){
        loadDisqus()
        disqus_loaded = true
      }
    }
  })
  
  function loadDisqus(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  }
</script>


  </main>
  <script src="/js/script.js"></script>
</body>
</html>
